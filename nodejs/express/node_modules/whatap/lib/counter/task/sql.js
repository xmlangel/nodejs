/**
 * Copyright 2016 the WHATAP project authors. All rights reserved.
 * Use of this source code is governed by a license that
 * can be found in the LICENSE file.
 */

var CounterTask = require('./counter-task'),
    MeterSql    = require('../meter/meter-sql'),
    IntIntMap   = require('../../util/intint-map');

function Sql() {
    CounterTask.call(this);
}

Sql.prototype = new CounterTask();
Sql.prototype.constructor = CounterTask;
Sql.prototype.process = function (p) {
    var sql = MeterSql.getBucketReset();

    p.sql_time = sql.time;
    p.sql_count = sql.count;
    p.sql_slow_count = sql.slow_count;
    p.sql_error = sql.error;

    p.jdbc_conn_open_count = sql.open_count;
    p.jdbc_conn_open_time=sql.open_time;

    p.sql_fetch_count = sql.fetch_count;
    p.sql_fetch_time = sql.fetch_time;
    p.sql_update_record = sql.update_record;
    p.sql_commit_count = sql.commit_count;

    p.sql_select = sql.sql_select;
    p.sql_update = sql.sql_update;
    p.sql_delete = sql.sql_delete;
    p.sql_insert = sql.sql_insert;
    p.sql_others = sql.sql_others;

    if(sql.db_conn_active > 0 || sql.db_conn_idle > 0) {
        if(p.db_num_active == null) {
            p.db_num_active = new IntIntMap(7, 1);
            p.db_num_idle = new IntIntMap(7, 1);
        }
        p.db_num_active.add(0, sql.db_conn_active);
        p.db_num_idle.add(0, sql.db_conn_idle);
    }
};

module.exports = Sql;