/**
 * Copyright 2016 the WHATAP project authors. All rights reserved.
 * Use of this source code is governed by a license that
 * can be found in the LICENSE file.
 */


var StatError       = require('./stat-error'),
    StatTranx       = require('./stat-tranx'),
    StatSql         = require('./stat-sql'),
    StatHttpc       = require('./stat-httpc'),
    StatRemoteIp    = require('./stat-remoteip'),
    StatUserAgent   = require('./stat-useragent'),
    DateUtil        = require('./../util/dateutil');

const MILLIS_FIVE_MINUTE = 10 * 1000;

function TimingSender(){
    this.time = Date.now();
    this.run();
}
TimingSender.prototype.run = function(){
    var self = this;

    var lastUnit = getCurrentFiveMinUnit();
    setInterval(function () {
        var nowUnit = getCurrentFiveMinUnit();

        if(nowUnit == lastUnit) {
            return;
        }

        lastUnit = nowUnit;
        var now = DateUtil.currentTime();

        StatTranx.send(now);
        StatSql.send(now);
        StatHttpc.send(now);
        StatRemoteIp.send(now);
        StatUserAgent.send(now);
        StatError.send(now);
    }, 1000);
};

function getCurrentFiveMinUnit() {
    return parseInt(DateUtil.currentTime() / MILLIS_FIVE_MINUTE) * MILLIS_FIVE_MINUTE
}

module.exports = new TimingSender();