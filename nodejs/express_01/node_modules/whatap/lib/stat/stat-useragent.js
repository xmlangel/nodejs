/**
 * Copyright 2016 the WHATAP project authors. All rights reserved.
 * Use of this source code is governed by a license that
 * can be found in the LICENSE file.
 */

var IntIntMap           = require('../util/intint-map'),
    StatUserAgentPack   = require('../pack/statuseragent-pack'),
    DataPackSender      = require('../data/datapack-sender'),
    Long                = require('long');

const TABLE_MAX_SIZE = 500;

function StatUserAgent() {
    if(typeof StatUserAgent.instance == 'object') {
        return StatUserAgent.instance;
    }

    this.table = new IntIntMap(TABLE_MAX_SIZE + 1, 1).setMax(TABLE_MAX_SIZE);

    StatUserAgent.instance = this;
}

StatUserAgent.prototype.incUserAgent = function (userAgent) {
    if(userAgent == 0) {
        return;
    }
    this.table.addNoOver(userAgent, 1);
};
StatUserAgent.prototype.send = function (now) {
    if(this.table.size() == 0) {
        return;
    }

    var p = new StatUserAgentPack();
    var en = this.table.entries();

    while(en.hasMoreElements()) {
        var e = en.nextElement();
        p.userAgents.put(e.getKey(), e.getValue());
    }
    p.time = Long.fromNumber(now);
    this.table.clear();
    DataPackSender.sendStatUserAgentPack(p);
};

module.exports = new StatUserAgent();
