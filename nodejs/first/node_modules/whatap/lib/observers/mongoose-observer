
var TraceContextManager = require('../trace/trace-context-manager');

var MongooseObserver = function (agent) {
    this.agent = agent;
    this.packages = ['mongoose'];
};

MongooseObserver.prototype.inject = function (mod, modName) {

    var self = this;

    var hookCommand = [
        'find',
        'remove',
        'findById',
        'findOne',
        'count',
        'distinct',
        'findOneAndUpdate',
        'findByIdAndUpdate',
        'findOneAndRemove',
        'findByIdAndRemove',
        'create',
        'insertMany',
        'update',
        'updateMany',
        'updateOne',
        'mapReduce',
        'geoNear',
        'geoSearch',
        'populate'
    ];

    self.agent.aop.before(mod.Model, hookCommand, function (obj, args) {
        var ctx_id = TraceContextManager.getCurrentId();
        self.agent.aop.functionHook(args, -1, function () {
            TraceContextManager.resume(ctx_id);
        });
    });

};

exports.MongooseObserver = MongooseObserver;